<!DOCTYPE html>
<html>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>近期黑苹果折腾小记</title>
    <meta name="description" content="Freelf's Blog" />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="//%E8%BF%91%E6%9C%9F%E9%BB%91%E8%8B%B9%E6%9E%9C%E6%8A%98%E8%85%BE%E5%B0%8F%E8%AE%B0" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="面向自由编程" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="近期黑苹果折腾小记" />
    <meta property="og:description" content="Freelf's Blog" />
    <meta property="og:url" content="//%E8%BF%91%E6%9C%9F%E9%BB%91%E8%8B%B9%E6%9E%9C%E6%8A%98%E8%85%BE%E5%B0%8F%E8%AE%B0" />
    <meta property="og:image" content="/assets/images/cover1.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="近期黑苹果折腾小记" />
    <meta name="twitter:description" content="Freelf's Blog" />
    <meta name="twitter:url" content="//%E8%BF%91%E6%9C%9F%E9%BB%91%E8%8B%B9%E6%9E%9C%E6%8A%98%E8%85%BE%E5%B0%8F%E8%AE%B0" />
    <meta name="twitter:image:src" content="/assets/images/cover1.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "面向自由编程",
    "name": "近期黑苹果折腾小记",
    "url": "//%E8%BF%91%E6%9C%9F%E9%BB%91%E8%8B%B9%E6%9E%9C%E6%8A%98%E8%85%BE%E5%B0%8F%E8%AE%B0",
    "image": "/assets/images/cover1.jpg",
    "description": "Freelf's Blog"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="面向自由编程" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->
<!-- The comment above "< default" means - insert everything in this file into -->
<!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data fom the post -->
<!-- #post -->
<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="/">Home</a>
        <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">近期黑苹果折腾小记</h1>
            <section class="post-meta">
                <!-- <a href='/'>Freelf</a> -->

                
                
                <!-- <a href='/author/Freelf'>Freelf</a> -->
                
                
                <time class="post-date" datetime="2020-04-24">24 Apr 2020</time>
                <!-- [[tags prefix=" on "]] -->
                
                <!-- on -->
                
                
                <a href='/tag/黑苹果'>黑苹果</a>
                
                
                
            </section>
        </header>

        <section class="post-content">

            <p>一直以来都想装一台黑苹果折腾一下，去年10月终于组装了一台。在近期也把电脑折腾完美了。配置如下：</p>

<table>
  <thead>
    <tr>
      <th>主板</th>
      <th>技嘉Z390m GAMING</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CPU</td>
      <td>i7 9700k</td>
    </tr>
    <tr>
      <td>GPU</td>
      <td>蓝宝石5700xt 超白金</td>
    </tr>
    <tr>
      <td>主SSD(macOS)</td>
      <td>三星 970 Pro M.2 500G</td>
    </tr>
    <tr>
      <td>副SSD(Windows10)</td>
      <td>Intel 660P M.2 1T</td>
    </tr>
    <tr>
      <td>内存</td>
      <td>芝奇幻光戟 16G  * 2</td>
    </tr>
    <tr>
      <td>电源</td>
      <td>海韵FOCUS GX750 750w</td>
    </tr>
    <tr>
      <td>水冷</td>
      <td>酷冷至尊冰神B240</td>
    </tr>
    <tr>
      <td>网卡蓝牙(黑苹果免驱)</td>
      <td>BCM94360CS2</td>
    </tr>
    <tr>
      <td>显示器</td>
      <td>LG 27UL850</td>
    </tr>
    <tr>
      <td>机箱</td>
      <td>酷冷至尊睿Lite3.1红色</td>
    </tr>
  </tbody>
</table>

<p>其中显卡最开始是蓝宝石Vega56，因为黑屏问题换成了5700xt。
桌面整理如下，秀一下我4K的壁纸，哈哈
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/wechatimg15.jpeg" alt="WechatIMG15" /></p>

<h2 id="发现问题">发现问题</h2>
<p>去年10月装完之后发现电脑有静电或者开关音响会自动黑屏，然后就只能重启。因为静电的出现频率不高，把音响和主机插到两个不同的插线板上，开关音响就不会导致黑屏了。所以当时并没有在意，也就不了了之了(主要是不想折腾了，哈哈)。直到今年年初因为疫情的原因在家办公，加上春天天气干燥，电脑经常黑屏，搞得心情烦躁，终于下定决心来找一下问题。</p>
<h2 id="确定黑屏原因">确定黑屏原因</h2>
<p>本着花钱节约时间的原则，约了京东的电脑上门维修服务，维修人员来了之后检测了一下告诉我是地线问题。我也不知道他是如何检测的，只拿着电表笔告诉我火线和底线之间应该有电压，但是测量出来我家里的没有。本着怀疑的态度，我自己买了一个电压表，回来检测了一下，家里的地线是正常的。于是联系京东售后重新检测，为了排除问题，维修人员把我电脑带到了维修站去检测，终于发现是显卡的问题，因为换一个其他显卡就不会出现这种问题。</p>
<h2 id="解决显卡问题">解决显卡问题</h2>
<p>因为最初装机时显卡是闲鱼买的二手的蓝宝石Vega56，所以当天立即联系卖家解决问题。卖家当时买了京东的延保服务，2年之内有问题可以直接换新。所以需要我把显卡寄给延保服务进行检测。在这里强烈谴责这个延保服务工作效率，检测问题就需要15个工作日。后面检测确实有问题，进行换新，因为Vega56没有现货了，所以自己补了差价，买了5700xt。收到货后放到电脑里面，把黑苹果引导配置重新折腾了一番，终于可以正常开机，并且没有了黑屏问题了。本以为到这里就算解决了显卡问题，哪知道前方还有坑在等我。
第二天早上想测试一下5700xt的性能，毕竟A卡高端卡。下载了Geekbench开始跑分，跑OpenCL刚开始10秒中，电脑直接卡住不动，然后自己重启了。当时我心里想可能需要预热一下，又跑了一次，结果还是同样的情况。切到Windows系统，下载Windows版本的Geekbench重新跑(这里表扬一下Geekbench的开发者，支持了Windows，让我排除了系统问题)，还是一样卡死，只是Windows不会重启。在这之后还下载了国产跑分软件鲁大师跑了一下，鲁大师告诉我我的显卡很厉害，超过了99%的电脑，我呵呵了。虽然我平常不用OpenCL的软件(从一个群友那里得知Adobe全家桶好像都用了OpenCL算法)，但是也不允许电脑有这种缺陷额，于是联系京东换货。京东客服告诉我他们需要检测有问题才能换货。我去，当时心里就想又检测，上次检测15个工作日，不会又来15个工作日吧。好在客服告诉我2-3个工作日就可以检测完成。于是尽快的把显卡寄给了京东售后，这里要夸一下京东的售后处理速度，第二天就给我说可以换货了，然后给我寄了一个新的显卡。装到电脑上，跑分不会卡住重启，黑屏的问题也解决了。</p>
<h2 id="优化5700xt在黑苹果下的跑分">优化5700xt在黑苹果下的跑分</h2>
<p>虽然跑分没问题了，但是5700xt在macOS下跑分只有3w左右，Windows下面可以到6w5左右。远景也有一些优化的帖子，但是我感觉小白不容易看懂。自己照着帖子研究了一段时间，终于明白了其中的一些原理。
因为5700xt这块显卡还没有苹果机器在用，只是在macOS10.15.1系统里面支持了Navi架构(5700xt是Navi10的架构)。所以想要正确驱动5700xt需要自己注册正确的RomId和EFIVersion进系统，只要正确注入了，跑分基本上可以到65000左右。注入的教程可以看<a href="https://bbs.pcbeta.org/viewthread-1839725-1-1.html">xjn大佬的优化贴</a>。我自己是用SSDT注入的，<a href="https://nightwish.oss-cn-beijing.aliyuncs.com/SSDT-GPU.aml">SSDT文件地址</a>，这个SSDT的作用有3个：</p>
<ol>
  <li>Change HECI To IMEI</li>
  <li>Change PEGP To GFX0</li>
  <li>注入5700xt信息</li>
</ol>

<p>如果要用SSDT需要自己修改以下的代码，把ATY,EFIVersionRomB和ATY,EFIVersionB替换成自己显卡的RomId，自己显卡的RomId可以通过Windows下的GPU-Z软件查看，剩下的几个不用修改。
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15876995810760.jpg" alt="-w438" /></p>

<p>用了这个SSDT还需要在config文件里面注入Change GFX0 To IGPU的补丁，也就是下图这样：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15876515157523.jpg" alt="-w783" />
这三个改名的其实是WhateverGreen的一部分，看xjn大佬的帖子，WhateverGreen其实干了以下几件事：</p>
<ol>
  <li>AMD框架等</li>
  <li>HECI, IGPU, PEGP的重命名</li>
  <li>核显驱动</li>
  <li>AGDP黑屏补丁</li>
</ol>

<p>AMD框架会影响独显的发挥，重命名的事我们自己做了，去掉核显驱动核显就可以拉满1.2GHz，AGDP黑屏补丁不能去掉。所以在我的EFI里面用了<a href="https://github.com/jyavenard/Vega5KFixup/releases">VegaGraphicsFixup</a>这个kext，没用WhateverGreen。这个里面只保留了AGDP黑屏补丁。通过这样设置5700xt在黑苹果下的跑分就和Windows下面一样了。下面对比一下优化前和优化后独显的跑分：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/wei-ming-ming.png" alt="未命名" /></p>

<p>下面是核显1.2GHz的满载：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15876531696127.jpg" alt="-w400" /></p>

<p>到这里已经可以说独显跑分正常，核显可以拉满性能。如果是视频工作者的朋友可以接着往下看，独显的跑分虽然正常了，但是独显还是可以接着优化的。独显默认的超频很小，可以通过注入一些内容，让独显在渲染视频时可以发挥更大的性能。</p>

<h2 id="5700xt超频优化">5700xt超频优化</h2>
<p>我的蓝宝石5700xt超白金，GPU最高频率是2100MHz，超频最高超到2150MHz，这也太少了。我们可以通过在config里面注入一些信息调整。调整超频需要用到一个excel表，表的内容大概如下：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877000843764.jpg" alt="-w1272" />
这里面是显卡的Bios信息，调整完这些信息可以在左下角获得一个Output值，把Output的值注入到config的DeviceProperties里面。
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877003531451.jpg" alt="-w1068" />
其中1是显卡的Device Path，每个人的主板不一样，对应的地址也不一样，可以通过Hackintool获取
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877005016001.jpg" alt="-w1298" />
找到PCIe下的显卡，然后复制设备地址出来，添加到DeviceProperties里面。
2是注入的Key，添加PP_PhmSoftPowerPlayTable这个key，value类型是data，然后把前面Excel表中的Output值填进去就可以了。
下面来说一下如何调整这个表，首先需要获取Rom信息，这个需要两个工具，并且需要再Windows下操作。其中一个工具是GPU-Z，用来导出显卡Bios信息，另外一个是MorePowerTool，用来查看Rom信息。</p>
<ol>
  <li>
    <p>通过GPU-Z导出显卡Bios信息：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877011140377.jpg" alt="" /></p>
  </li>
  <li>
    <p>通过MorePowerTool加载导出的信息：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877011748826.jpg" alt="" />
点击load加载导出的文件，然后对上面5个标签展示的页面分别截图保存，比如我的就是下面这样的：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877019678461.jpg" alt="-w842" /></p>
  </li>
</ol>

<p>这些信息对应上面Excel表中的信息，可以先把上面Excel表中的每个字段都按照当前显卡信息填一遍，然后再去调整超频。我自己调整的超频是在上面这些信息的基础上调整了表中的5个值：</p>
<ol>
  <li>Max Memory Clock： 从1900调整到了2000，表中的Max Memory Clock对应的是上图的Memory Maximum Clock，而且表中对应值=上图中的值 * 2，我的显卡信息对应的是950，表中的就是1900，我调整到了2000。</li>
  <li>Max GPU Clock (MHz)：从2150调整到了2300</li>
  <li>Power Limit (%) Maximum：从50调整到了90</li>
  <li>Power Limit GPU (W)：从220调整到了250</li>
  <li>MaxVoltageSoc：从1050调整到了1250</li>
</ol>

<p>其他的都是按照上图默认的填进去的，调整完可以从左下角的Output把值复制出来，填到config的PP_PhmSoftPowerPlayTable里面。我调整的这几个值是从xjn大佬调整的结果，因为到现在为止，苹果系统没有开5700xt的传感器接口，所以不能瞎填，还是在大佬们的调整结果上自己改一些东西。我是自己加了风扇控制，如果直接用<a href="http://bbs.pcbeta.com/viewthread-1836920-1-1.html">这个帖子</a>里面调整完的结果，显卡的风扇会一直转。我调整到显卡温度到65度才会开始转，这样静音效果比较好。
如果用别人已经调好了值，自己想在这种结果上修改，可以看一下Excel表中最后的Output怎么来的：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877026565671.jpg" alt="-w1206" />
可以看到Output的值其实就是左面Output上面所有单元格的值拼起来，我们修改右侧的一些值，左侧的带颜色的单元格的值就会变化，最后Output的值也会变化，其中左侧单元格颜色对应的就是右面单元格每行相对应颜色的值，也是一个函数，下面随便来举一个例子：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877029035511.jpg" alt="-w1202" />
看上图中的FC，函数对应的是AD4，意思就是这个单元格的值就是AD列，第4行的值，右侧第4行的颜色和左侧FC单元格的颜色是一样的，再看AD4的值就是FC，再点到AD4上，看到对应的函数：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877030733739.jpg" alt="-w1204" />
AD4取的值是AC4的后两位，再去看AC4的值是怎么来的：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877031455907.jpg" alt="-w1207" />
可以看到AC4的值是AB4的16进制数，并且格式化成4位，2300的16进制可以算一下：
<img src="https://nightwish.oss-cn-beijing.aliyuncs.com/2020/04/24/15877032104748.jpg" alt="-w572" />
可以看到2300的16进制是8fc，然后格式化成4位，高位加0，就是08FC，通过上面一系列可以得到，我们修改AB4单元格的值可以影响到左侧的Output值。所以拿到别人调整好的Output值，想在调整好的值上面修改一些东西可以这样对应一下去修改。</p>
<h2 id="总结">总结</h2>
<p>如果没有这场疫情，可能自己永远都不会想着去解决黑屏的问题，还是用着那个有问题的显卡。所以以后应该直面一些问题，问题总会解决的。只是需要些时间嘛。</p>

<p>再说后面调整显卡，其实自己完全可以将就着用，直接把其他大佬调整的值抄过来。但是用抄过来的值显卡风扇会一直转，像我这么追求完美的人怎么会允许风扇一直转(不经意间又自夸了一下，哈哈)。只能自己去探索一下了，本来以为很难的事情，经过探索那个Excel表发现，其实大佬只是调整了超频的几个值，风扇的自动控制是关的，只要把风扇的自动控制打开就可以达到自己想要的效果了。所以有些东西看起来很难，但是稍微去研究一下就会发现其实还蛮简单的。</p>

<p>有的人说了，追求完美直接去买白苹果啊，折腾啥黑苹果。哎，没办法，我就想折腾一些自己没玩过的东西。黑果可以撸代码，还可以切Windows玩游戏，爽歪歪。白果显卡太垃圾，升级不合算，还是黑果香～</p>



        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
            
            
            <figure class="author-image">
                <a class="img" href="https://github.com/zhangdongpo" style="background-image: url(/assets/images/freelf.jpg)"><span
                        class="hidden">Freelf's Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/Freelf">Freelf</a></h4>

                
                <p> iOS Developer</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Beijing, China</span>
                    <span class="author-link icon-link"><a href="https://freelf.me"> freelf.me</a></span>
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=近期黑苹果折腾小记&amp;url=%E8%BF%91%E6%9C%9F%E9%BB%91%E8%8B%B9%E6%9E%9C%E6%8A%98%E8%85%BE%E5%B0%8F%E8%AE%B0"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=%E8%BF%91%E6%9C%9F%E9%BB%91%E8%8B%B9%E6%9E%9C%E6%8A%98%E8%85%BE%E5%B0%8F%E8%AE%B0"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=%E8%BF%91%E6%9C%9F%E9%BB%91%E8%8B%B9%E6%9E%9C%E6%8A%98%E8%85%BE%E5%B0%8F%E8%AE%B0"
                    onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            

            <!-- Add Disqus Comments -->
            
            <div id="gitalk-container"></div>
<script src="/assets/js/md5.min.js"></script>
<script>
    const gitalk = new Gitalk({
        clientID: 'b62d799fc3a6b1dd7de9',
        clientSecret: 'd5a315aa0855dd6a00cdb4025b88059c1b0c585f',
        repo: 'blog',
        owner: 'zhangdongpo',
        admin: 'zhangdongpo',
        id: md5(location.pathname), // Ensure uniqueness and length less than 50
        distractionFreeMode: false // Facebook-like distraction free mode
    })
    gitalk.render('gitalk-container')
</script>
            

        </footer>

    </article>

</main>

<!-- /post -->

        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">面向自由编程</a> &copy; 2020</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', '', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
