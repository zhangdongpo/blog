<?xml version="1.0" encoding="UTF-8" ?>

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
   
      <title>freelf.me</title>
   
   <link></link>
   <description>Freelf's Blog</description>
   <language>en-uk</language>
   <managingEditor> Freelf</managingEditor>
   <atom:link href="rss" rel="self" type="application/rss+xml" />
   
	<item>
	  <title>iOS 13 ScrollView截图问题记录</title>
	  <link>//iOS-13-ScrollView%E6%88%AA%E5%9B%BE%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95</link>
	  <author>Freelf</author>
	  <pubDate>2019-09-24T00:00:00+00:00</pubDate>
	  <guid>//iOS-13-ScrollView%E6%88%AA%E5%9B%BE%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95</guid>
	  <description><![CDATA[
	     <p>最近有个需求，需要给TabelView截图。当时做的比较着急，从stackoverflow上面抄了如下一段代码，并且可以正常运行。代码如下：</p>
<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UIImage</span><span class="o">*</span> <span class="n">image</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
<span class="n">UIGraphicsBeginImageContext</span><span class="p">(</span><span class="n">_scrollView</span><span class="p">.</span><span class="n">contentSize</span><span class="p">);</span>
<span class="p">{</span>
	<span class="n">CGPoint</span> <span class="n">savedContentOffset</span> <span class="o">=</span> <span class="n">_scrollView</span><span class="p">.</span><span class="n">contentOffset</span><span class="p">;</span>
	<span class="n">CGRect</span> <span class="n">savedFrame</span> <span class="o">=</span> <span class="n">_scrollView</span><span class="p">.</span><span class="n">frame</span><span class="p">;</span>

	<span class="n">_scrollView</span><span class="p">.</span><span class="n">contentOffset</span> <span class="o">=</span> <span class="n">CGPointZero</span><span class="p">;</span>
	<span class="n">_scrollView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_scrollView</span><span class="p">.</span><span class="n">contentSize</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">_scrollView</span><span class="p">.</span><span class="n">contentSize</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="p">[</span><span class="n">_scrollView</span><span class="p">.</span><span class="n">layer</span> <span class="nf">renderInContext</span><span class="p">:</span> <span class="n">UIGraphicsGetCurrentContext</span><span class="p">()];</span>     
	<span class="n">image</span> <span class="o">=</span> <span class="n">UIGraphicsGetImageFromCurrentImageContext</span><span class="p">();</span>

	<span class="n">_scrollView</span><span class="p">.</span><span class="n">contentOffset</span> <span class="o">=</span> <span class="n">savedContentOffset</span><span class="p">;</span>
	<span class="n">_scrollView</span><span class="p">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">savedFrame</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">UIGraphicsEndImageContext</span><span class="p">();</span>
</code></pre></div></div>
<p>最近发版，QA同学在iOS13的手机上面测试，发现这个方法截图只能截到TableView高度的图，没有截到TableView全部的图。于是仔细看了一下截图的代码，发现原理是把TableView的frame改为和TableView的containerSize相同后，再去截图，但是在iOS13上面不好用。经过各种尝试，发现可以通过创建一个和TableView大小相同的临时view，然后把TableView添加到这个临时view，然后再对这个临时view进行截图，就可以再iOS13上面截到完整的图了。代码如下：</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (UIImage *)getTableViewImageWithTabelview:(UITableView *)tableview{
    UIImage* viewImage = nil;
    UITableView *scrollView = tableview;
    UIGraphicsBeginImageContextWithOptions(scrollView.contentSize, NO, 0.0);
    {
		// 保存原来的偏移量
        CGPoint savedContentOffset = scrollView.contentOffset;
        // CGPoint savedFrame = scrollView.frame;

		// 设置截图需要的偏移量和frame
        scrollView.contentOffset = CGPointZero;
        scrollView.frame = CGRectMake(0, 0, scrollView.contentSize.width, scrollView.contentSize.height);
        
		// 创建临时view，并且把要截图的view添加到临时view上面
        UIView *tempView = [[UIView alloc]initWithFrame:CGRectMake(0, 0, scrollView.contentSize.width, scrollView.contentSize.height)];
        [scrollView removeFromSuperview];
        [tempView addSubview:scrollView];
        
		// 对临时view进行截图
        [tempView.layer renderInContext:UIGraphicsGetCurrentContext()];
        viewImage = UIGraphicsGetImageFromCurrentImageContext();
        
		// 恢复截图view原来的状态
        [scrollView removeFromSuperview];
        [self addSubview:scrollView];
        scrollView.contentOffset = savedContentOffset;

		// 如果原来是frame布局，需要设置frame，如果是Auto layout需要再次进行Auto layout布局。
		// scrollView.frame = savedFrame;
        [scrollView mas_makeConstraints:^(MASConstraintMaker *make) 	{
            make.edges.equalTo(self);
        }];
    }
    UIGraphicsEndImageContext();
    
    return viewImage;
}
</code></pre></div></div>
<p>这里需要注意，如果原来TableView用的是Auto layout进行的布局，那么后面需要对TableView再次进行布局。不然的话，截图之后会发现TableView不见了。</p>

	  ]]></description>
	</item>


</channel>
</rss>
